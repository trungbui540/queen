if not game:IsLoaded() then game.Loaded:Wait() end

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

-- Remotes
local giftRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("GiftItem")
local acceptRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("AcceptGift")
local removeRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("RemoveItem")
local ItemSell = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("ItemSell")
local FavoriteRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("FavoriteItem")

local Backpack = LocalPlayer:WaitForChild("Backpack", 10)
local giftQueue, giftSet = {}, {}
local maxQueueSize, acceptThrottle = 50, 1

LocalPlayer.CharacterAdded:Connect(function(newChar)
    character = newChar
    task.wait(1)
    Backpack = LocalPlayer:WaitForChild("Backpack", 10)
end)

-- ğŸ“¨ Queue xá»­ lÃ½ nháº­n gift
local function pushGift(id)
    if not id or type(id) ~= "number" or giftSet[id] then return end
    if #giftQueue >= maxQueueSize then
        local old = table.remove(giftQueue, 1)
        if old then giftSet[old] = nil end
    end
    table.insert(giftQueue, id)
    giftSet[id] = true
end

-- ğŸ§© Hook remote nháº­n quÃ 
local function safeHookRemotes()
    local toCheck = {}
    if ReplicatedStorage:FindFirstChild("Remotes") then
        local r = ReplicatedStorage.Remotes
        if r:FindFirstChild("GiftItem") then table.insert(toCheck, r.GiftItem) end
        if r:FindFirstChild("AcceptGift") then table.insert(toCheck, r.AcceptGift) end
    end

    if #toCheck == 0 then
        local maybeGift = ReplicatedStorage:FindFirstChild("GiftItem")
        if maybeGift then table.insert(toCheck, maybeGift) end
    end

    for _, remote in ipairs(toCheck) do
        if remote:IsA("RemoteEvent") then
            remote.OnClientEvent:Connect(function(...)
                for _, a in ipairs({...}) do
                    if type(a) == "table" and a.ID then
                        pcall(pushGift, a.ID)
                    end
                end
            end)
        end
    end
end

-- ğŸ”„ Tá»± Ä‘á»™ng accept gift
task.spawn(function()
    safeHookRemotes()

    while true do
        task.wait(0.25)
        if _G.CF and _G.CF.acceptGifts and acceptRemote then
            local id = table.remove(giftQueue, 1)
            if id then
                giftSet[id] = nil
                local ok, err = pcall(function()
                    acceptRemote:FireServer({ID = id})
                end)
                if ok then
                    print("âœ… Accepted gift", id)
                else
                    warn("âŒ Accept failed:", tostring(err))
                end
                task.wait(acceptThrottle)
            end
        end
    end
end)

-- ğŸ Gá»­i quÃ 
local function ToGift()
    local receivers = type(_G.CF.Receivers) == "table" and _G.CF.Receivers or {_G.CF.Receivers}
    local Humanoid = character:FindFirstChildOfClass("Humanoid")
    if not Humanoid then return warn("KhÃ´ng tÃ¬m tháº¥y Humanoid!") end

    local myName = LocalPlayer.Name
    if table.find(receivers, myName) then
        print("ğŸš« NgÆ°á»i gá»­i náº±m trong danh sÃ¡ch Receivers, bá» qua.")
        return
    end

    local totalSent = 0
    local minDamage = _G.CF.MinDamage or 0
    local maxDamage = _G.CF.MaxDamage or math.huge
    local giftCooldown = _G.CF.giftCooldown or 2
    local listPetGift = _G.CF.ListPetGift or {}

    for _, receiverName in ipairs(receivers) do
        if receiverName == myName then continue end
        local receiver = Players:FindFirstChild(receiverName)
        if not receiver then
            warn("âš ï¸ NgÆ°á»i nháº­n OFFLINE:", receiverName)
            continue
        end

        print(("\nğŸ Gá»­i cho: %s"):format(receiverName))
        for _, item in ipairs(Backpack:GetChildren()) do
            if not item:IsA("Tool") then continue end
            if string.find(item.Name:lower(), "seed") then continue end

            local dmg = tonumber(item:GetAttribute("Damage")) or 0
            local isInList = false
            for _, name in ipairs(listPetGift) do
                if string.find(item.Name:lower(), name:lower()) then
                    isInList = true break
                end
            end

            if not (isInList or (dmg >= minDamage and dmg <= maxDamage)) then continue end

            local ok, err = pcall(function()
                Humanoid:EquipTool(item)
                task.wait(0.25)
                local equipped = character:FindFirstChildOfClass("Tool")
                if equipped then
                    giftRemote:FireServer({{Item = equipped, ToGift = receiverName}})
                    totalSent += 1
                    print(("âœ… Sent '%s' (Dmg %d) â†’ %s"):format(item.Name, dmg, receiverName))
                end
            end)
            if not ok then warn(("âŒ Lá»—i gá»­i '%s': %s"):format(item.Name, err)) end

            for _, t in ipairs(character:GetChildren()) do
                if t:IsA("Tool") then t.Parent = Backpack end
            end

            task.wait(giftCooldown)
        end
    end
    print(("âœ¨ Tá»•ng cá»™ng Ä‘Ã£ gá»­i %d pets."):format(totalSent))
end

-- ğŸ§¹ XoÃ¡ pet khá»i plots
local function removeAllPetsFromPlots()
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return warn("âŒ KhÃ´ng tÃ¬m tháº¥y workspace.Plots!") end
    local plot = plots:FindFirstChild("1")
    if not plot then return warn("âŒ KhÃ´ng tÃ¬m tháº¥y plot '1'!") end
    local hitboxes = plot:FindFirstChild("Hitboxes")
    if not hitboxes then return warn("âŒ KhÃ´ng tÃ¬m tháº¥y Hitboxes!") end

    print("ğŸ§¹ Äang xoÃ¡ pets trong Plot 1...")
    local count = 0
    for _, obj in ipairs(hitboxes:GetChildren()) do
        local uuid = obj:GetAttribute("UUID")
        if uuid then
            pcall(function() removeRemote:FireServer(uuid) end)
            count += 1
        end
        task.wait(0.25)
    end
    print(("âœ¨ ÄÃ£ xoÃ¡ %d pets khá»i Plot."):format(count))
end

-- ğŸ’° BÃ¡n items khi Ä‘áº§y
local function SellMaxInventory()
    local hud = LocalPlayer.PlayerGui:FindFirstChild("HUD")
    if not hud then return false end

    local maxInvObj = hud:FindFirstChild("MaxInv")
    if not maxInvObj then return false end

    local maxInv = tonumber(maxInvObj.Value or maxInvObj.Text) or 250
    local itemCount = #Backpack:GetChildren()
    if itemCount < maxInv then return false end

    print(("Full %d/%d - Start Sell!"):format(itemCount, maxInv))
    ItemSell:FireServer()
    task.wait(0.5)

    local popup = hud:FindFirstChild("PopUp")
    if not popup or not popup.Visible then return false end

    local yesBtn = popup:FindFirstChild("Content")
        and popup.Content:FindFirstChild("Buttons")
        and popup.Content.Buttons:FindFirstChild("Yes")
        and popup.Content.Buttons.Yes:FindFirstChild("TextButton")
    if not yesBtn then return false end

    pcall(function()
        for _, conn in pairs(getconnections(yesBtn.Activated)) do conn:Fire() end
        for _, conn in pairs(getconnections(yesBtn.MouseButton1Click)) do conn:Fire() end
    end)

    print("âœ… ÄÃ£ xÃ¡c nháº­n bÃ¡n items.")
    task.wait(0.5)
    return true
end

-- ğŸ§  Kiá»ƒm tra inventory
local function CheckAndManageInventory()
    if not Backpack then return end
    local hud = LocalPlayer.PlayerGui:FindFirstChild("HUD")
    if not hud then return end

    local maxInvObj = hud:FindFirstChild("MaxInv")
    if not maxInvObj then return end

    local maxInv = tonumber(maxInvObj.Value or maxInvObj.Text) or 250
    if #Backpack:GetChildren() >= maxInv then
        print("ğŸ“¦ Full Inventory â†’ BÃ¡n + XoÃ¡ pets...")
        pcall(SellMaxInventory)
        task.wait(3)
        pcall(removeAllPetsFromPlots)
    end
end

-- ğŸ” VÃ²ng láº·p chÃ­nh
task.spawn(function()
    task.wait(2)
    while true do
        pcall(CheckAndManageInventory)
        task.wait(1)

        if _G.CF.autoFavorite then
            print("\nâ­ QuÃ©t vÃ  favorite pets...")
            pcall(scanAndFavoritePets)
            task.wait(2)
        end

        if _G.CF.autoSendGift then
            print("\nğŸ“¦ Gá»­i gifts...")
            pcall(ToGift)
            task.wait(3)
        end
    end
end)

print("âœ… Script loaded! Auto loops started.")
