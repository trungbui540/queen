if not game:IsLoaded() then game.Loaded:Wait() end

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

-- Remotes
local giftRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("GiftItem")
local acceptRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("AcceptGift")
local removeRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("RemoveItem")
local ItemSell = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("ItemSell")
local FavoriteRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("FavoriteItem")

local Backpack = LocalPlayer:WaitForChild("Backpack", 10)
local giftQueue, giftSet = {}, {}
local maxQueueSize, acceptThrottle = 50, 1

LocalPlayer.CharacterAdded:Connect(function(newChar)
    character = newChar
    task.wait(1)
    Backpack = LocalPlayer:WaitForChild("Backpack", 10)
end)

-- üì® Queue x·ª≠ l√Ω nh·∫≠n gift
local function pushGift(id)
    if not id or type(id) ~= "number" or giftSet[id] then return end
    if #giftQueue >= maxQueueSize then
        local old = table.remove(giftQueue, 1)
        if old then giftSet[old] = nil end
    end
    table.insert(giftQueue, id)
    giftSet[id] = true
end

-- üß© Hook remote nh·∫≠n qu√†
local function safeHookRemotes()
    local toCheck = {}
    if ReplicatedStorage:FindFirstChild("Remotes") then
        local r = ReplicatedStorage.Remotes
        if r:FindFirstChild("GiftItem") then table.insert(toCheck, r.GiftItem) end
        if r:FindFirstChild("AcceptGift") then table.insert(toCheck, r.AcceptGift) end
    end

    if #toCheck == 0 then
        local maybeGift = ReplicatedStorage:FindFirstChild("GiftItem")
        if maybeGift then table.insert(toCheck, maybeGift) end
    end

    for _, remote in ipairs(toCheck) do
        if remote:IsA("RemoteEvent") then
            remote.OnClientEvent:Connect(function(...)
                for _, a in ipairs({...}) do
                    if type(a) == "table" and a.ID then
                        pcall(pushGift, a.ID)
                    end
                end
            end)
        end
    end
end

-- üîÑ T·ª± ƒë·ªông accept gift
task.spawn(function()
    safeHookRemotes()

    while true do
        task.wait(0.25)
        if _G.CF and _G.CF.acceptGifts and acceptRemote then
            local id = table.remove(giftQueue, 1)
            if id then
                giftSet[id] = nil
                local ok, err = pcall(function()
                    acceptRemote:FireServer({ID = id})
                end)
                if ok then
                    print("‚úÖ Accepted gift", id)
                else
                    warn("‚ùå Accept failed:", tostring(err))
                end
                task.wait(acceptThrottle)
            end
        end
    end
end)

-- üéÅ G·ª≠i qu√†
local function ToGift()
    local receivers = type(_G.CF.Receivers) == "table" and _G.CF.Receivers or {_G.CF.Receivers}
    local Humanoid = character:FindFirstChildOfClass("Humanoid")
    if not Humanoid then return warn("Kh√¥ng t√¨m th·∫•y Humanoid!") end

    local myName = LocalPlayer.Name
    if table.find(receivers, myName) then
        print("üö´ Ng∆∞·ªùi g·ª≠i n·∫±m trong danh s√°ch Receivers, b·ªè qua.")
        return
    end

    local totalSent = 0
    local minDamage = _G.CF.MinDamage or 0
    local maxDamage = _G.CF.MaxDamage or math.huge
    local giftCooldown = _G.CF.giftCooldown or 2
    local listPetGift = _G.CF.ListPetGift or {}

    for _, receiverName in ipairs(receivers) do
        if receiverName == myName then continue end
        local receiver = Players:FindFirstChild(receiverName)
        if not receiver then
            warn("‚ö†Ô∏è Ng∆∞·ªùi nh·∫≠n OFFLINE:", receiverName)
            continue
        end

        print(("\nüéÅ G·ª≠i cho: %s"):format(receiverName))
        for _, item in ipairs(Backpack:GetChildren()) do
            if not item:IsA("Tool") then continue end
            if string.find(item.Name:lower(), "seed") then continue end

            local dmg = tonumber(item:GetAttribute("Damage")) or 0
            local isInList = false
            for _, name in ipairs(listPetGift) do
                if string.find(item.Name:lower(), name:lower()) then
                    isInList = true break
                end
            end

            if not (isInList or (dmg >= minDamage and dmg <= maxDamage)) then continue end

            local ok, err = pcall(function()
                Humanoid:EquipTool(item)
                task.wait(0.25)
                local equipped = character:FindFirstChildOfClass("Tool")
                if equipped then
                    giftRemote:FireServer({{Item = equipped, ToGift = receiverName}})
                    totalSent += 1
                    print(("‚úÖ Sent '%s' (Dmg %d) ‚Üí %s"):format(item.Name, dmg, receiverName))
                end
            end)
            if not ok then warn(("‚ùå L·ªói g·ª≠i '%s': %s"):format(item.Name, err)) end

            for _, t in ipairs(character:GetChildren()) do
                if t:IsA("Tool") then t.Parent = Backpack end
            end

            task.wait(giftCooldown)
        end
    end
    print(("‚ú® T·ªïng c·ªông ƒë√£ g·ª≠i %d pets."):format(totalSent))
end

local function removeAllPetsFromPlots()
    local count = 0
    for _, plot in pairs(workspace.Plots:GetChildren()) do
        local hitboxes = plot:FindFirstChild("Hitboxes")
        if hitboxes then
            for _, pet in pairs(hitboxes:GetChildren()) do
                task.wait(0.25) -- let game finish any animations
                pcall(function()
                    removeRemote:FireServer(pet.Name)
                end)
                count = count + 1
                task.wait(0.2)
            end
        end
    end
end


local function SellMaxInventory()
    local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
    if not playerGui then return false end
    
    local hud = playerGui:FindFirstChild("HUD")
    if not hud then return false end
    
    local maxInvObj = hud:FindFirstChild("MaxInv")
    if not maxInvObj then return false end
    
    local maxInventory = 250
    if maxInvObj:IsA("IntValue") or maxInvObj:IsA("NumberValue") then
        maxInventory = maxInvObj.Value
    elseif maxInvObj:IsA("TextLabel") or maxInvObj:IsA("TextBox") then
        maxInventory = tonumber(maxInvObj.Text) or 250
    end
    
    local itemCount = #Backpack:GetChildren()
    
    if itemCount < maxInventory then
        print(("Inventory %d/%d - Not Full"):format(itemCount, maxInventory))
        return false
    end
    
    print(("Full %d/%d - Start Sell!"):format(itemCount, maxInventory))
    
    local success = pcall(function()
        ItemSell:FireServer()
    end)
    
    if not success then
        warn("erro request selling")
        return false
    end
    
    task.wait(0.5)
    
    local popupGui = hud:FindFirstChild("PopUp")
    if not popupGui then return false end
    
    local content = popupGui:FindFirstChild("Content")
    if not content then return false end
    
    local buttons = content:FindFirstChild("Buttons")
    if not buttons then return false end
    
    local yes = buttons:FindFirstChild("Yes")
    if not yes then return false end
    
    local yesBtn = yes:FindFirstChild("TextButton")
    if not yesBtn then return false end
    
    local timeout = 0
    while not popupGui.Visible and timeout < 10 do
        task.wait(0.1)
        timeout = timeout + 0.1
    end
    
    if not popupGui.Visible then
        warn("Popup not show")
        return false
    end
    
    task.wait(0.2)
    print("YES...")

    pcall(function()
        for _, conn in pairs(getconnections(yesBtn.Activated)) do
            conn:Fire()
        end
    end)
    
    pcall(function()
        for _, conn in pairs(getconnections(yesBtn.MouseButton1Click)) do
            conn:Fire()
        end
    end)
    
    task.wait(0.5)
    return true
end

-- üß† Ki·ªÉm tra inventory
local function CheckAndManageInventory()
    if not Backpack then
        warn("Backpack does not exist")
        return
    end
    
    local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
    if not playerGui then return end
    
    local hud = playerGui:FindFirstChild("HUD")
    if not hud then return end
    
    local maxInvObj = hud:FindFirstChild("MaxInv")
    if not maxInvObj then return end
    
    local maxInventory = 250
    if maxInvObj:IsA("IntValue") or maxInvObj:IsA("NumberValue") then
        maxInventory = maxInvObj.Value
    elseif maxInvObj:IsA("TextLabel") or maxInvObj:IsA("TextBox") then
        maxInventory = tonumber(maxInvObj.Text) or 250
    end
    
    local itemCount = #Backpack:GetChildren()
    
    if itemCount >= maxInventory then
        print("  ‚Üí quest 1: Ban items...")
        pcall(SellMaxInventory)
        task.wait(3)
        print("  ‚Üí quest 2: Xoa pets khoi plots...")
        pcall(removeAllPetsFromPlots)
    else
        print("Inventory OK, xoa pets khoi plots...")
        pcall(removeAllPetsFromPlots)
    end
end

-- üîÅ V√≤ng l·∫∑p ch√≠nh
task.spawn(function()
    task.wait(2)
    while true do
        pcall(CheckAndManageInventory)
        task.wait(1)

        if _G.CF.autoFavorite then
            print("\n‚≠ê Qu√©t v√† favorite pets...")
            pcall(scanAndFavoritePets)
            task.wait(2)
        end

        if _G.CF.autoSendGift then
            print("\nüì¶ G·ª≠i gifts...")
            pcall(ToGift)
            task.wait(3)
        end
    end
end)

print("‚úÖ Script loaded! Auto loops started.")

