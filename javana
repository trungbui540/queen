if not game:IsLoaded() then game.Loaded:Wait() end

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

-- Remotes
local giftRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("GiftItem")
local acceptRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("AcceptGift")
local removeRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("RemoveItem")
local ItemSell = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("ItemSell")
local FavoriteRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("FavoriteItem")

local Backpack = LocalPlayer:WaitForChild("Backpack", 10)
local giftQueue, giftSet = {}, {}
local maxQueueSize, acceptThrottle = 50, 1

LocalPlayer.CharacterAdded:Connect(function(newChar)
    character = newChar
    task.wait(1)
    Backpack = LocalPlayer:WaitForChild("Backpack", 10)
end)

-- ğŸ“¨ Queue xá»­ lÃ½ nháº­n gift
local function pushGift(id)
    if not id or type(id) ~= "number" or giftSet[id] then return end
    if #giftQueue >= maxQueueSize then
        local old = table.remove(giftQueue, 1)
        if old then giftSet[old] = nil end
    end
    table.insert(giftQueue, id)
    giftSet[id] = true
end

-- ğŸ§© Hook remote nháº­n quÃ 
local function safeHookRemotes()
    local toCheck = {}
    if ReplicatedStorage:FindFirstChild("Remotes") then
        local r = ReplicatedStorage.Remotes
        if r:FindFirstChild("GiftItem") then table.insert(toCheck, r.GiftItem) end
        if r:FindFirstChild("AcceptGift") then table.insert(toCheck, r.AcceptGift) end
    end

    if #toCheck == 0 then
        local maybeGift = ReplicatedStorage:FindFirstChild("GiftItem")
        if maybeGift then table.insert(toCheck, maybeGift) end
    end

    for _, remote in ipairs(toCheck) do
        if remote:IsA("RemoteEvent") then
            remote.OnClientEvent:Connect(function(...)
                for _, a in ipairs({...}) do
                    if type(a) == "table" and a.ID then
                        pcall(pushGift, a.ID)
                    end
                end
            end)
        end
    end
end

-- ğŸ”„ Tá»± Ä‘á»™ng accept gift
task.spawn(function()
    safeHookRemotes()

    while true do
        task.wait(0.25)
        if _G.CF and _G.CF.acceptGifts and acceptRemote then
            local id = table.remove(giftQueue, 1)
            if id then
                giftSet[id] = nil
                local ok, err = pcall(function()
                    acceptRemote:FireServer({ID = id})
                end)
                if ok then
                    print("âœ… Accepted gift", id)
                else
                    warn("âŒ Accept failed:", tostring(err))
                end
                task.wait(acceptThrottle)
            end
        end
    end
end)

local isGifting = false

local function ToGift()
    if isGifting then
        warn(" Äang gá»­i gift, bá» qua láº§n gá»i trÃ¹ng!")
        return
    end
    isGifting = true

    local receivers = type(_G.CF.Receivers) == "table" and _G.CF.Receivers or {_G.CF.Receivers}
    local Humanoid = character:FindFirstChildOfClass("Humanoid")
    if not Humanoid then
        warn("KhÃ´ng tÃ¬m tháº¥y Humanoid!")
        isGifting = false
        return
    end

    local myName = LocalPlayer.Name
    local totalSent = 0
    local minDamage = _G.CF.MinDamage or 0
    local maxDamage = _G.CF.MaxDamage or math.huge
    local giftCooldown = _G.CF.giftCooldown or 2
    local listPetGift = _G.CF.ListPetGift or {}
    
    -- âœ… KIá»‚M TRA CHáº¾ Äá»˜ Lá»ŒC
    local useListFilter = #listPetGift > 0
    local useDamageFilter = not (minDamage == 0 and maxDamage == 0)

    print(" Báº¯t Ä‘áº§u gá»­i pets...")
    if useListFilter and useDamageFilter then
        print(" Cháº¿ Ä‘á»™: Lá»c theo ListPetGift + Damage (" .. minDamage .. "-" .. maxDamage .. ")")
    elseif useListFilter then
        print(" Cháº¿ Ä‘á»™: Lá»c chá»‰ theo ListPetGift (bá» qua damage)")
    elseif useDamageFilter then
        print(" Cháº¿ Ä‘á»™: Lá»c chá»‰ theo Damage (" .. minDamage .. "-" .. maxDamage .. ")")
    else
        print(" Cháº¿ Ä‘á»™: Gift Táº¤T Cáº¢ pet (khÃ´ng lá»c)")
    end

    for _, receiverName in ipairs(receivers) do
        if receiverName == myName then continue end
        local receiver = Players:FindFirstChild(receiverName)
        if not receiver then
            warn("âš ï¸ NgÆ°á»i nháº­n OFFLINE:", receiverName)
            continue
        end

        local sentCount = 0
        for _, item in ipairs(Backpack:GetChildren()) do
            if not item:IsA("Tool") then continue end
            if string.find(item.Name:lower(), "seed") then continue end

            -- âœ… KIá»‚M TRA LISTPETGIFT (náº¿u cÃ³)
            if useListFilter then
                local matchList = false
                for _, pet in ipairs(listPetGift) do
                    if string.find(item.Name:lower(), pet:lower()) then
                        matchList = true
                        break
                    end
                end
                if not matchList then continue end
            end

            -- âœ… Láº¤Y DAMAGE (chá»‰ khi cáº§n)
            local petDamage = 0
            if useDamageFilter then
                local damageValue = item:FindFirstChild("Damage")
                
                if damageValue then
                    if damageValue:IsA("IntValue") or damageValue:IsA("NumberValue") then
                        petDamage = damageValue.Value
                    elseif damageValue:IsA("StringValue") then
                        petDamage = tonumber(damageValue.Value) or 0
                    end
                else
                    petDamage = item:GetAttribute("Damage") or 0
                end

                -- âœ… KIá»‚M TRA DAMAGE RANGE
                if petDamage < minDamage or petDamage > maxDamage then
                    print(("â­ï¸ Bá» qua %s (Damage: %d, yÃªu cáº§u: %d-%d)"):format(
                        item.Name, petDamage, minDamage, maxDamage
                    ))
                    continue
                end
            end

            local ok, err = pcall(function()
                Humanoid:EquipTool(item)
                task.wait(0.3)
                local equipped = character:FindFirstChildOfClass("Tool")
                if equipped then
                    giftRemote:FireServer({Item = equipped, ToGift = receiverName})
                    totalSent += 1
                    sentCount += 1
                    if useDamageFilter then
                        print(("âœ… Gá»­i %s (DMG: %d) â†’ %s"):format(item.Name, petDamage, receiverName))
                    else
                        print(("âœ… Gá»­i %s â†’ %s"):format(item.Name, receiverName))
                    end
                end
            end)
            if not ok then
                warn("âŒ Lá»—i gift:", err)
            end

            local timeout = 0
            repeat
                task.wait(0.1)
                timeout += 0.1
            until not character:FindFirstChildOfClass("Tool") or timeout > 3

            task.wait(giftCooldown)
        end

        print(("ğŸ¯ ÄÃ£ gá»­i %d pets cho %s"):format(sentCount, receiverName))
        task.wait(1)
    end

    print(("âœ¨ Tá»•ng cá»™ng gá»­i xong %d pets."):format(totalSent))
    isGifting = false
end

local function getUUID(obj)
    local uuid = obj:GetAttribute("UUID")
    if uuid then return uuid end
    
    for _, v in pairs(obj:GetAttributes()) do
        if type(v) == "string" and v:match("%x%x%x%x%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%x%x%x%x%x%x%x%x") then
            return v
        end
    end
end

local function isInList(name, list)
    for _, item in pairs(list) do
        if name:lower():find(item:lower()) then
            return true
        end
    end
    return false
end

local function removeAllPetsFromPlots()
    local workspace = game:GetService("Workspace")
    local plots = workspace:FindFirstChild("Plots")
    
    if not plots then
        warn("Not Found Plots")
        return
    end
    
    local count = 0
    
    for _, plot in pairs(plots:GetChildren()) do
        local plants = plot:FindFirstChild("Plants")
        if plants then
            for _, plant in pairs(plants:GetChildren()) do
                if isInList(plant.Name, _G.CF.ListPetGift) then
                    local uuid = getUUID(plant)
                    
                    if uuid then
                        local success = pcall(function()
                            removeRemote:FireServer(uuid)
                        end)
                        
                        if success then
                            count = count + 1
                            print("delete ", plant.Name)
                            task.wait(0.3)
                        else
                            warn("erro delete ", plant.Name)
                        end
                    end
                end
            end
        end
    end
    
    print(("Delete %d pets From plots"):format(count))
end

local function SellMaxInventory()
    local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
    if not playerGui then return false end
    
    local hud = playerGui:FindFirstChild("HUD")
    if not hud then return false end
    
    local maxInvObj = hud:FindFirstChild("MaxInv")
    if not maxInvObj then return false end
    
    local maxInventory = 250
    if maxInvObj:IsA("IntValue") or maxInvObj:IsA("NumberValue") then
        maxInventory = maxInvObj.Value
    elseif maxInvObj:IsA("TextLabel") or maxInvObj:IsA("TextBox") then
        maxInventory = tonumber(maxInvObj.Text) or 250
    end
    
    local itemCount = #Backpack:GetChildren()
    
    if itemCount < maxInventory then
        print(("Inventory %d/%d - Not Full"):format(itemCount, maxInventory))
        return false
    end
    
    print(("Full %d/%d - Start Sell!"):format(itemCount, maxInventory))
    
    local success = pcall(function()
        ItemSell:FireServer()
    end)
    
    if not success then
        warn("erro request selling")
        return false
    end
    
    task.wait(0.5)
    
    local popupGui = hud:FindFirstChild("PopUp")
    if not popupGui then return false end
    
    local content = popupGui:FindFirstChild("Content")
    if not content then return false end
    
    local buttons = content:FindFirstChild("Buttons")
    if not buttons then return false end
    
    local yes = buttons:FindFirstChild("Yes")
    if not yes then return false end
    
    local yesBtn = yes:FindFirstChild("TextButton")
    if not yesBtn then return false end
    
    local timeout = 0
    while not popupGui.Visible and timeout < 10 do
        task.wait(0.1)
        timeout = timeout + 0.1
    end
    
    if not popupGui.Visible then
        warn("Popup not show")
        return false
    end
    
    task.wait(0.2)
    print("YES...")

    pcall(function()
        for _, conn in pairs(getconnections(yesBtn.Activated)) do
            conn:Fire()
        end
    end)
    
    pcall(function()
        for _, conn in pairs(getconnections(yesBtn.MouseButton1Click)) do
            conn:Fire()
        end
    end)
    
    task.wait(0.5)
    return true
end

local function CheckAndManageInventory()
    if not Backpack then
        warn("Backpack does not exist")
        return
    end
    
    local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
    if not playerGui then return end
    
    local hud = playerGui:FindFirstChild("HUD")
    if not hud then return end
    
    local maxInvObj = hud:FindFirstChild("MaxInv")
    if not maxInvObj then return end
    
    local maxInventory = 250
    if maxInvObj:IsA("IntValue") or maxInvObj:IsA("NumberValue") then
        maxInventory = maxInvObj.Value
    elseif maxInvObj:IsA("TextLabel") or maxInvObj:IsA("TextBox") then
        maxInventory = tonumber(maxInvObj.Text) or 250
    end
    
    local itemCount = #Backpack:GetChildren()
    
    if itemCount >= maxInventory then
        print("  â†’ quest 1: Ban items...")
        pcall(SellMaxInventory)
        task.wait(3)
        print("  â†’ quest 2: Xoa pets khoi plots...")
        pcall(removeAllPetsFromPlots)
    else
        print("Inventory OK, xoa pets khoi plots...")
        pcall(removeAllPetsFromPlots)
    end
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ”¥ CHANGEACCCUSTOM - LOGIC HOÃ€N CHá»ˆNH
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- ğŸ“Š Biáº¿n lÆ°u tráº¡ng thÃ¡i
local changeAccTriggered = false
local lastCheckTime = 0
local CHECK_INTERVAL = 5 -- Kiá»ƒm tra má»—i 5 giÃ¢y

-- ğŸ§© HÃ m kiá»ƒm tra pet cÃ²n láº¡i trong ListPetGift
local function checkRemainingPetsInList()
    if not Backpack then 
        warn("âš ï¸ Backpack khÃ´ng tá»“n táº¡i")
        return -1 
    end
    
    local listPetGift = _G.CF.ListPetGift or {}
    if #listPetGift == 0 then
        return -1 -- KhÃ´ng cÃ³ list Ä‘á»ƒ check
    end
    
    local remaining = 0
    local foundPets = {}
    
    -- QuÃ©t toÃ n bá»™ Backpack
    for _, item in pairs(Backpack:GetChildren()) do
        if not item:IsA("Tool") then continue end
        if string.find(item.Name:lower(), "seed") then continue end
        
        -- Kiá»ƒm tra xem pet cÃ³ trong ListPetGift khÃ´ng
        for _, petName in ipairs(listPetGift) do
            if string.find(item.Name:lower(), petName:lower()) then
                remaining += 1
                table.insert(foundPets, item.Name)
                break
            end
        end
    end
    
    return remaining, foundPets
end

-- ğŸ“ HÃ m ghi file trigger Ä‘á»ƒ ChangeAcc executor Ä‘á»c
local function writeTriggerFile()
    if changeAccTriggered then 
        return false -- ÄÃ£ trigger rá»“i, khÃ´ng ghi láº¡i
    end
    
    local fileName = tostring(LocalPlayer.Name) .. ".txt"
    local content = "Yummytool" -- Ná»™i dung file trigger
    
    local success = pcall(function()
        writefile(fileName, content)
    end)
    
    if success then
        changeAccTriggered = true
        print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        print("ğŸ”„ [CHANGEACC TRIGGER] File Ä‘Ã£ Ä‘Æ°á»£c táº¡o!")
        print("ğŸ“ File:", fileName)
        print("ğŸ’¾ Content:", content)
        print("â° Thá»i gian:", os.date("%H:%M:%S"))
        print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        return true
    else
        warn("âŒ KhÃ´ng thá»ƒ ghi file trigger:", fileName)
        return false
    end
end

-- ğŸ¯ HÃ m chÃ­nh: Kiá»ƒm tra vÃ  trigger Ä‘á»•i acc
local function checkAndTriggerChangeAcc()
    if not _G.CF or not _G.CF.changeAccCustom then 
        return 
    end
    
    if changeAccTriggered then 
        return -- ÄÃ£ trigger rá»“i, khÃ´ng check ná»¯a
    end
    
    -- Throttle: KhÃ´ng check quÃ¡ nhanh
    local currentTime = tick()
    if currentTime - lastCheckTime < CHECK_INTERVAL then
        return
    end
    lastCheckTime = currentTime
    
    -- Kiá»ƒm tra sá»‘ lÆ°á»£ng pet cÃ²n láº¡i
    local remaining, foundPets = checkRemainingPetsInList()
    
    if remaining == -1 then
        return -- ListPetGift khÃ´ng tá»“n táº¡i hoáº·c rá»—ng
    end
    
    if remaining > 0 then
        print(("ğŸ¾ [ChangeAccCustom] CÃ²n %d pets trong ListPetGift"):format(remaining))
        if foundPets and #foundPets > 0 then
            print("   â””â”€ Pets:", table.concat(foundPets, ", "))
        end
        return
    end
    
    -- âœ… Háº¿t pet trong list â†’ Trigger Ä‘á»•i acc
    print("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘  ğŸ‰ ÄÃƒ GIFT Háº¾T PET TRONG LISTPETGIFT!           â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    
    writeTriggerFile()
end

-- ğŸ”„ HÃ m reset tráº¡ng thÃ¡i (dÃ¹ng khi cáº§n test láº¡i)
local function resetChangeAccStatus()
    changeAccTriggered = false
    lastCheckTime = 0
    print("ğŸ”ƒ Reset tráº¡ng thÃ¡i ChangeAccCustom")
    
    local fileName = tostring(LocalPlayer.Name) .. ".txt"
    if isfile(fileName) then
        delfile(fileName)
        print("ğŸ—‘ï¸ ÄÃ£ xÃ³a file trigger cÅ©:", fileName)
    end
end

-- ğŸ“Š HÃ m debug: Hiá»ƒn thá»‹ thÃ´ng tin chi tiáº¿t
local function debugChangeAccStatus()
    print("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘          ğŸ” DEBUG CHANGEACCCUSTOM STATUS          â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print("âš™ï¸ Cáº¥u hÃ¬nh:")
    print("   â€¢ changeAccCustom:", _G.CF and _G.CF.changeAccCustom or false)
    print("   â€¢ ListPetGift:", _G.CF and #(_G.CF.ListPetGift or {}) or 0, "items")
    
    local remaining, foundPets = checkRemainingPetsInList()
    print("\nğŸ“Š Tráº¡ng thÃ¡i:")
    print("   â€¢ Pets cÃ²n láº¡i:", remaining == -1 and "N/A" or remaining)
    print("   â€¢ ÄÃ£ trigger:", changeAccTriggered)
    print("   â€¢ Last check:", lastCheckTime == 0 and "ChÆ°a check" or os.date("%H:%M:%S", lastCheckTime))
    
    local fileName = tostring(LocalPlayer.Name) .. ".txt"
    print("   â€¢ File trigger:", isfile(fileName) and "âœ… Tá»“n táº¡i" or "âŒ KhÃ´ng tá»“n táº¡i")
    
    if foundPets and #foundPets > 0 then
        print("\nğŸ¾ Pets tÃ¬m tháº¥y:")
        for i, name in ipairs(foundPets) do
            print(("   %d. %s"):format(i, name))
        end
    end
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
end

-- ğŸŒ Export global functions (Ä‘á»ƒ gá»i tá»« console)
_G.resetChangeAcc = resetChangeAccStatus
_G.debugChangeAcc = debugChangeAccStatus

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ” VÃ’NG Láº¶P CHÃNH - TÃCH Há»¢P CHANGEACCCUSTOM
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

task.spawn(function()
    task.wait(2)
    print("âœ… Script loaded! Auto loops started.")
    print("ğŸ”§ ChangeAccCustom:", _G.CF and _G.CF.changeAccCustom or false)
    
    while true do
        -- 1ï¸âƒ£ Quáº£n lÃ½ inventory
        pcall(CheckAndManageInventory)
        task.wait(1)

        -- 2ï¸âƒ£ Auto favorite (náº¿u báº­t)
        if _G.CF and _G.CF.autoFavorite then
            print("\nâ­ QuÃ©t vÃ  favorite pets...")
            pcall(scanAndFavoritePets)
            task.wait(2)
        end

        -- 3ï¸âƒ£ Auto send gift (náº¿u báº­t)
        if _G.CF and _G.CF.autoSendGift then
            if not isGifting then
               pcall(ToGift)
            else
            print("â³ Äang gá»­i gift, bá» qua vÃ²ng nÃ y.")
            end
            task.wait(3)

            
            -- 4ï¸âƒ£ âœ¨ KIá»‚M TRA CHANGEACCCUSTOM SAU KHI GIFT
            if _G.CF and _G.CF.changeAccCustom then
                pcall(checkAndTriggerChangeAcc)
            end
        end
        
        -- 5ï¸âƒ£ Delay trÆ°á»›c cycle tiáº¿p theo
        task.wait(2)
    end
end)
