if not game:IsLoaded() then game.Loaded:Wait() end

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

-- Remotes
local giftRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("GiftItem")
local acceptRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("AcceptGift")
local removeRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("RemoveItem")
local ItemSell = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("ItemSell")
local FavoriteRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("FavoriteItem") 

local Backpack = LocalPlayer:WaitForChild("Backpack", 10)
local giftQueue = {}
local giftSet = {}
local maxQueueSize = 50
local acceptThrottle = 1

LocalPlayer.CharacterAdded:Connect(function(newChar)
    character = newChar
    task.wait(1)
    Backpack = LocalPlayer:WaitForChild("Backpack", 10)
end)


local function pushGift(id)
    if not id then return end
    if type(id) ~= "number" then return end
    if giftSet[id] then return end
    if #giftQueue >= maxQueueSize then
        local old = table.remove(giftQueue, 1)
        if old then giftSet[old] = nil end
    end
    table.insert(giftQueue, id)
    giftSet[id] = true
end

local function safeHookRemotes()
    local toCheck = {}
    if ReplicatedStorage:FindFirstChild("Remotes") then
        local r = ReplicatedStorage.Remotes
        if r:FindFirstChild("GiftItem") then table.insert(toCheck, r.GiftItem) end
        if r:FindFirstChild("AcceptGift") then table.insert(toCheck, r.AcceptGift) end
    end

    if #toCheck == 0 then
        local maybeGift = ReplicatedStorage:FindFirstChild("GiftItem")
        if maybeGift then table.insert(toCheck, maybeGift) end
    end

    for _, remote in ipairs(toCheck) do
        if remote and remote:IsA("RemoteEvent") and remote.OnClientEvent then
            remote.OnClientEvent:Connect(function(...)
                local args = {...}
                for _, a in ipairs(args) do
                    if type(a) == "table" and a.ID and type(a.ID) == "number" then
                        local ok = pcall(pushGift, a.ID)
                        if not ok then
                        end
                    end
                end
            end)
        end
    end
end

task.spawn(function()
    safeHookRemotes()

    while true do
        task.wait(0.25)

        if _G.CF and _G.CF.acceptGifts and acceptRemote and acceptRemote:IsA("RemoteEvent") then
            local id = table.remove(giftQueue, 1)
            if id then
                giftSet[id] = nil
                local ok, err = pcall(function()
                    acceptRemote:FireServer({ID = id})
                end)
                if ok then
                    print("Accepted gift", id)
                else
                    warn("Accept failed:", tostring(err))
                end
                task.wait(acceptThrottle)
            end
        end

        if #giftQueue > 20 then
            task.wait(1)
        end
    end
end)

local function ToGift()
    local receivers = type(_G.CF.Receivers) == "table" and _G.CF.Receivers or {_G.CF.Receivers}
    local Humanoid = character:FindFirstChildOfClass("Humanoid")
    if not Humanoid then
        warn("Humanoid not found!")
        return
    end

    local myName = LocalPlayer.Name
    local totalSent = 0
    local mode = string.lower(_G.CF.Mode or "list")
    local minDamage = _G.CF.MinDamage or 0
    local maxDamage = _G.CF.MaxDamage or math.huge
    local giftCooldown = _G.CF.giftCooldown or 2
    local listPetGift = _G.CF.ListPetGift or {}

    print("üë§ Ng∆∞·ªùi g·ª≠i:", myName)
    if mode == "damage" then
        print(("üîß Ch·∫ø ƒë·ªô: G·ª¨I THEO DAMAGE (%d‚Äì%d)"):format(minDamage, maxDamage))
    else
        print(("üìú Ch·∫ø ƒë·ªô: G·ª¨I THEO DANH S√ÅCH T√äN (%d pet trong danh s√°ch)"):format(#listPetGift))
    end

    local senderIsReceiver = table.find(receivers, myName) and true or false
    print(("üîé T√¥i c√≥ n·∫±m trong Receivers kh√¥ng? %s"):format(tostring(senderIsReceiver)))

    -- Duy·ªát qua danh s√°ch RECEIVERS (ch·ªâ g·ª≠i ƒë·∫øn nh·ªØng ng∆∞·ªùi trong receivers)
    for _, receiverName in ipairs(receivers) do
        if receiverName == myName then
            print("‚è© B·ªè qua v√¨ l√† ch√≠nh m√¨nh:", receiverName)
            continue
        end

        local targetIsReceiver = table.find(receivers, receiverName) and true or false

        -- Debug: in ra tr·∫°ng th√°i ƒë·ªÉ b·∫°n ki·ªÉm tra
        print(("‚û° Ki·ªÉm tra target '%s' : targetIsReceiver=%s"):format(receiverName, tostring(targetIsReceiver)))

        -- CH√çNH: ch·ªâ g·ª≠i khi ng∆∞·ªùi g·ª≠i KH√îNG n·∫±m trong Receivers, nh∆∞ng ng∆∞·ªùi nh·∫≠n N·∫∞M trong Receivers
        if senderIsReceiver then
            print(("üö´ Ng∆∞·ªùi g·ª≠i (%s) n·∫±m trong Receivers => kh√¥ng g·ª≠i cho ai trong Receivers (b·ªè qua %s)"):format(myName, receiverName))
            continue
        end

        if not targetIsReceiver then
            print(("üö´ Ng∆∞·ªùi nh·∫≠n %s kh√¥ng n·∫±m trong Receivers => b·ªè qua"):format(receiverName))
            continue
        end

        -- Ng∆∞·ªùi nh·∫≠n h·ª£p l·ªá (receiver n·∫±m trong list v√† sender kh√¥ng n·∫±m trong list)
        local receiver = Players:FindFirstChild(receiverName)
        if not receiver then
            warn("‚ö†Ô∏è Ng∆∞·ªùi nh·∫≠n OFFLINE:", receiverName)
            continue
        end

        print("\nüéÅ G·ª≠i cho:", receiverName)
        local sentCount = 0

        for _, item in ipairs(Backpack:GetChildren()) do
            if not item:IsA("Tool") then continue end
            if string.find(item.Name:lower(), "seed") then continue end

            -- L·∫•y damage (n·∫øu c√≥)
            local damageValue = 0
            if item:GetAttribute and item:GetAttribute("Damage") then
                damageValue = tonumber(item:GetAttribute("Damage")) or 0
            else
                local info = item:FindFirstChild("Info") or item:FindFirstChild("Stats") or item:FindFirstChild("Configuration")
                if info and info:FindFirstChild("Damage") then
                    damageValue = tonumber(info.Damage.Value) or 0
                end
            end

            -- Ki·ªÉm tra pet h·ª£p l·ªá theo Mode / List
            local isValid = false
            if mode == "damage" then
                if damageValue >= minDamage and damageValue <= maxDamage then
                    isValid = true
                end
            else
                for _, name in ipairs(listPetGift) do
                    if string.find(item.Name:lower(), name:lower()) then
                        isValid = true
                        break
                    end
                end
            end

            if not isValid then
                if mode == "damage" then
                    print(("'%s' Damage %d - ngo√†i kho·∫£ng"):format(item.Name, damageValue))
                end
                continue
            end

            -- Th·ª±c hi·ªán equip + g·ª≠i
            local ok, err = pcall(function()
                Humanoid:EquipTool(item)
                task.wait(0.3) -- tƒÉng delay ƒë·ªÉ ƒë·∫£m b·∫£o equip
                local equipped = character:FindFirstChildOfClass("Tool")
                if equipped and equipped.Name == item.Name then
                    local args = {{Item = equipped, ToGift = receiverName}}
                    giftRemote:FireServer(unpack(args))
                    totalSent = totalSent + 1
                    sentCount = sentCount + 1
                    print(("‚úÖ G·ª≠i '%s' (Damage: %d) ‚Üí %s"):format(item.Name, damageValue, receiverName))
                else
                    warn(("‚ö†Ô∏è Kh√¥ng equip ƒë∆∞·ª£c '%s' tr∆∞·ªõc khi g·ª≠i"):format(item.Name))
                end
            end)

            if not ok then
                warn(("‚ùå L·ªói khi g·ª≠i '%s': %s"):format(item.Name, tostring(err)))
            end

            -- √âp g·ª° tool v·ªÅ Backpack (ph√≤ng tr∆∞·ªùng h·ª£p server ch∆∞a remove)
            task.wait(0.2)
            for _, tool in ipairs(character:GetChildren()) do
                if tool:IsA("Tool") then
                    tool.Parent = Backpack
                end
            end

            -- Ch·ªù tool bi·∫øn m·∫•t kh·ªèi character
            local timeout = 0
            repeat
                task.wait(0.1)
                timeout = timeout + 0.1
            until not character:FindFirstChildOfClass("Tool") or timeout > 3

            task.wait(giftCooldown)
        end

        print(("üéØ ƒê√£ g·ª≠i %d pets cho %s"):format(sentCount, receiverName))
    end

    print(("\n‚ú® T·ªïng c·ªông ƒë√£ g·ª≠i: %d pets.\n"):format(totalSent))
end


local function SellMaxInventory()
    local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
    if not playerGui then return false end
    
    local hud = playerGui:FindFirstChild("HUD")
    if not hud then return false end
    
    local maxInvObj = hud:FindFirstChild("MaxInv")
    if not maxInvObj then return false end
    
    local maxInventory = 250
    if maxInvObj:IsA("IntValue") or maxInvObj:IsA("NumberValue") then
        maxInventory = maxInvObj.Value
    elseif maxInvObj:IsA("TextLabel") or maxInvObj:IsA("TextBox") then
        maxInventory = tonumber(maxInvObj.Text) or 250
    end
    
    local itemCount = #Backpack:GetChildren()
    
    if itemCount < maxInventory then
        print(("Inventory %d/%d - Not Full"):format(itemCount, maxInventory))
        return false
    end
    
    print(("Full %d/%d - Start Sell!"):format(itemCount, maxInventory))
    
    local success = pcall(function()
        ItemSell:FireServer()
    end)
    
    if not success then
        warn("erro request selling")
        return false
    end
    
    task.wait(0.5)
    
    local popupGui = hud:FindFirstChild("PopUp")
    if not popupGui then return false end
    
    local content = popupGui:FindFirstChild("Content")
    if not content then return false end
    
    local buttons = content:FindFirstChild("Buttons")
    if not buttons then return false end
    
    local yes = buttons:FindFirstChild("Yes")
    if not yes then return false end
    
    local yesBtn = yes:FindFirstChild("TextButton")
    if not yesBtn then return false end
    
    local timeout = 0
    while not popupGui.Visible and timeout < 10 do
        task.wait(0.1)
        timeout = timeout + 0.1
    end
    
    if not popupGui.Visible then
        warn("Popup not show")
        return false
    end
    
    task.wait(0.2)
    print("YES...")

    pcall(function()
        for _, conn in pairs(getconnections(yesBtn.Activated)) do
            conn:Fire()
        end
    end)
    
    pcall(function()
        for _, conn in pairs(getconnections(yesBtn.MouseButton1Click)) do
            conn:Fire()
        end
    end)
    
    task.wait(0.5)
    return true
end


local function getUUID(obj)
    local uuid = obj:GetAttribute("UUID")
    if uuid then return uuid end
    
    for _, v in pairs(obj:GetAttributes()) do
        if type(v) == "string" and v:match("%x%x%x%x%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%x%x%x%x%x%x%x%x") then
            return v
        end
    end
end

local function isInList(name, list)
    for _, item in pairs(list) do
        if name:lower():find(item:lower()) then
            return true
        end
    end
    return false
end

local function removeAllPetsFromPlots()
    local workspace = game:GetService("Workspace")
    local plots = workspace:FindFirstChild("Plots")
    
    if not plots then
        warn("Not Found Plots")
        return
    end
    
    local count = 0
    
    for _, plot in pairs(plots:GetChildren()) do
        local plants = plot:FindFirstChild("Plants")
        if plants then
            for _, plant in pairs(plants:GetChildren()) do
                if isInList(plant.Name, _G.CF.ListPetGift) then
                    local uuid = getUUID(plant)
                    
                    if uuid then
                        local success = pcall(function()
                            removeRemote:FireServer(uuid)
                        end)
                        
                        if success then
                            count = count + 1
                            print("delete ", plant.Name)
                            task.wait(0.3)
                        else
                            warn("erro delete ", plant.Name)
                        end
                    end
                end
            end
        end
    end
    
    print(("Delete %d pets From plots"):format(count))
end

local function isFavorited(slot)
    local heart = slot:FindFirstChild("HeartIcon")
    return heart and heart.Visible
end

local function getPetName(slot)
    local name = slot:GetAttribute("PetName")
    if name then return name end
    
    for _, child in ipairs(slot:GetDescendants()) do
        if child:IsA("TextLabel") and child.Text ~= "" and not tonumber(child.Text) then
            return child.Text
        end
    end
end

local function tryFavorite(slot, idx, location)
    local petName = getPetName(slot)
    if not petName or not isInList(petName, _G.CF.ListPetGift) then 
        return false 
    end
    
    if isFavorited(slot) then
        return true
    end

    local uuid = getUUID(slot)
    
    if not uuid then
        for _, item in ipairs(Backpack:GetChildren()) do
            if item.Name:lower():find(petName:lower()) then
                uuid = getUUID(item)
                if uuid then break end
            end
        end
    end

    if uuid then
        print(("[%s] Favorite %s (Slot %d)"):format(location, petName, idx))
        FavoriteRemote:FireServer(uuid)
        task.wait(0.3)
        return true
    else
        warn(("[%s] Not Found UUID %s"):format(location, petName))
    end
    return false
end

local function scanAndFavoritePets()
    local backpackGui = LocalPlayer:FindFirstChild("PlayerGui")
    if not backpackGui then 
        warn("Not Found PlayerGui")
        return 
    end
    
    backpackGui = backpackGui:FindFirstChild("BackpackGui")
    if not backpackGui then 
        warn("Not Found BackpackGui")
        return 
    end
    
    local containers = {
        {
            path = {"Backpack","Inventory","ScrollingFrame","UIGridFrame"}, 
            range = 250, 
            name = "Inventory"
        },
        {
            path = {"Backpack","Hotbar"}, 
            range = 10, 
            name = "Hotbar"
        },
    }

    for _, cfg in ipairs(containers) do
        local gui = backpackGui
        
        for _, name in ipairs(cfg.path) do
            if gui then 
                gui = gui:FindFirstChild(name) 
            else
                break
            end
        end
        
        if not gui then
            warn("Not Found:", cfg.name)
        else
            print(("Sweep %s..."):format(cfg.name))
            local count = 0
            
            for i = 1, cfg.range do
                local slot = gui:FindFirstChild(tostring(i))
                if slot and tryFavorite(slot, i, cfg.name) then
                    count = count + 1
                end
            end
            
            if count > 0 then
                print(("%s: %d pets favorite"):format(cfg.name, count))
            end
        end
    end
end


local function CheckAndManageInventory()
    if not Backpack then
        warn("Backpack does not exist")
        return
    end
    
    local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
    if not playerGui then return end
    
    local hud = playerGui:FindFirstChild("HUD")
    if not hud then return end
    
    local maxInvObj = hud:FindFirstChild("MaxInv")
    if not maxInvObj then return end
    
    local maxInventory = 250
    if maxInvObj:IsA("IntValue") or maxInvObj:IsA("NumberValue") then
        maxInventory = maxInvObj.Value
    elseif maxInvObj:IsA("TextLabel") or maxInvObj:IsA("TextBox") then
        maxInventory = tonumber(maxInvObj.Text) or 250
    end
    
    local itemCount = #Backpack:GetChildren()
    
    if itemCount >= maxInventory then
        print("  ‚Üí quest 1: Ban items...")
        pcall(SellMaxInventory)
        task.wait(3)
        print("  ‚Üí quest 2: Xoa pets khoi plots...")
        pcall(removeAllPetsFromPlots)
    else
        print("Inventory OK, xoa pets khoi plots...")
        pcall(removeAllPetsFromPlots)
    end
end


spawn(function()
    task.wait(2)
    while true do
        print("\n Kiem tra inventory...")
        pcall(CheckAndManageInventory)
        task.wait(1)
        
        if _G.CF.autoFavorite then
            print("\n Quet v√† favorite pets...")
            pcall(scanAndFavoritePets)
            task.wait(2)
        end
        
        if _G.CF.autoSendGift then
            print("\n sent gift...")
            pcall(ToGift)
            task.wait(3)
        end
    end
end)

print(" Script loaded! Auto loops started.")
