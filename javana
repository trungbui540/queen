if not game:IsLoaded() then game.Loaded:Wait() end

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local character = LocalPlayer.Character 

-- Remotes
local giftRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("GiftItem")
local acceptRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("AcceptGift")
local removeRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("RemoveItem")
local ItemSell = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("ItemSell")
local FavoriteRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("FavoriteItem") -- âœ… Fix missing

local Backpack = LocalPlayer:WaitForChild("Backpack", 10)
local giftQueue = {}

-- Update character reference
LocalPlayer.CharacterAdded:Connect(function(newChar)
    character = newChar
    task.wait(1)
    Backpack = LocalPlayer:WaitForChild("Backpack", 10)
end)


local function hookAllRemotes()
    for _, obj in pairs(ReplicatedStorage:GetDescendants()) do
        if obj:IsA("RemoteEvent") and obj.OnClientEvent then
            obj.OnClientEvent:Connect(function(...)
                local args = {...}
                for _, arg in pairs(args) do
                    if typeof(arg) == "table" and arg.ID and typeof(arg.ID) == "number" and arg.ID > 1000000000 then
                        table.insert(giftQueue, arg.ID)
                    end
                end
            end)
        end
    end
end

spawn(function()
    hookAllRemotes()
    while task.wait(1) do
        if _G.CF.acceptGifts and #giftQueue > 0 then
            local giftID = table.remove(giftQueue, 1)
            local success, err = pcall(function()
                acceptRemote:FireServer({ID = giftID})
            end)
            if success then
                print("âœ… Accepted gift:", giftID)
            else
                warn("âŒ Failed to accept:", err)
            end
        end
    end
end)


local function ToGift()
    local receivers = type(_G.CF.Receivers) == "table" and _G.CF.Receivers or {_G.CF.Receivers}
    local Humanoid = character:FindFirstChildOfClass("Humanoid")
    if not Humanoid then 
        warn("âŒ KhÃ´ng tÃ¬m tháº¥y Humanoid")
        return 
    end
    
    local myName = LocalPlayer.Name
    local totalSent = 0
    
    print("\nðŸŽ Báº®T Äáº¦U Gá»¬I QUÃ€")
    print("ðŸ‘¤ NgÆ°á»i gá»­i:", myName)

    for _, receiverName in pairs(receivers) do
        -- Skip náº¿u lÃ  chÃ­nh mÃ¬nh
        if receiverName == myName then
            print("â­ï¸ Bá» qua:", receiverName, "(lÃ  chÃ­nh mÃ¬nh)")
            continue
        end
        
        local receiver = Players:FindFirstChild(receiverName)
        if not receiver then
            warn("âš ï¸ NgÆ°á»i nháº­n OFFLINE:", receiverName)
            continue
        end
        
        print("\nâœ… TÃ¬m tháº¥y:", receiverName)

        for _, petName in pairs(_G.CF.ListPetGift) do
            local foundPet = false

            for _, item in pairs(Backpack:GetChildren()) do
                if item:IsA("Tool") and string.find(item.Name:lower(), petName:lower()) then
                    foundPet = true
                    task.wait(0.3)

                    local success = pcall(function()
                        Humanoid:EquipTool(item)
                    end)

                    if not success then
                        warn("âŒ KhÃ´ng equip Ä‘Æ°á»£c:", item.Name)
                        break
                    end

                    task.wait(0.5)
                    local petTool = character:FindFirstChildOfClass("Tool")
                    
                    if petTool and string.find(petTool.Name:lower(), petName:lower()) then
                        local args = {{Item = petTool, ToGift = receiverName}}
                        local sendSuccess, err = pcall(function()
                            giftRemote:FireServer(unpack(args))
                        end)

                        if sendSuccess then
                            print(("ðŸ“¤ ÄÃƒ Gá»¬I: '%s' â†’ '%s'"):format(petTool.Name, receiverName))
                            totalSent = totalSent + 1
                            task.wait(_G.CF.giftCooldown)
                        else
                            warn(("âŒ Lá»—i gá»­i: %s"):format(tostring(err)))
                        end
                    end
                    break
                end
            end

            if not foundPet then
                warn(("âš ï¸ KhÃ´ng tÃ¬m tháº¥y: '%s'"):format(petName))
            end
        end
    end
    
    print(("\nðŸ“Š Tá»”NG: ÄÃ£ gá»­i %d pets\n"):format(totalSent))
end

local function SellMaxInventory()
    local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
    if not playerGui then return false end
    
    local hud = playerGui:FindFirstChild("HUD")
    if not hud then return false end
    
    local maxInvObj = hud:FindFirstChild("MaxInv")
    if not maxInvObj then return false end
    
    local maxInventory = 250
    if maxInvObj:IsA("IntValue") or maxInvObj:IsA("NumberValue") then
        maxInventory = maxInvObj.Value
    elseif maxInvObj:IsA("TextLabel") or maxInvObj:IsA("TextBox") then
        maxInventory = tonumber(maxInvObj.Text) or 250
    end
    
    local itemCount = #Backpack:GetChildren()
    
    if itemCount < maxInventory then
        print(("ðŸ“¦ Inventory: %d/%d - ChÆ°a Ä‘áº§y"):format(itemCount, maxInventory))
        return false
    end
    
    print(("ðŸ”´ Äáº¦Y: %d/%d - Báº®T Äáº¦U BÃN!"):format(itemCount, maxInventory))
    
    local success = pcall(function()
        ItemSell:FireServer()
    end)
    
    if not success then
        warn("âŒ Lá»—i gá»­i yÃªu cáº§u bÃ¡n")
        return false
    end
    
    task.wait(0.5)
    
    local popupGui = hud:FindFirstChild("PopUp")
    if not popupGui then return false end
    
    local content = popupGui:FindFirstChild("Content")
    if not content then return false end
    
    local buttons = content:FindFirstChild("Buttons")
    if not buttons then return false end
    
    local yes = buttons:FindFirstChild("Yes")
    if not yes then return false end
    
    local yesBtn = yes:FindFirstChild("TextButton")
    if not yesBtn then return false end
    
    -- Äá»£i popup hiá»‡n
    local timeout = 0
    while not popupGui.Visible and timeout < 10 do
        task.wait(0.1)
        timeout = timeout + 0.1
    end
    
    if not popupGui.Visible then
        warn("â±ï¸ Popup khÃ´ng hiá»‡n")
        return false
    end
    
    task.wait(0.2)
    print("ðŸŸ¢ Báº¥m YES...")

    pcall(function()
        for _, conn in pairs(getconnections(yesBtn.Activated)) do
            conn:Fire()
        end
    end)
    
    pcall(function()
        for _, conn in pairs(getconnections(yesBtn.MouseButton1Click)) do
            conn:Fire()
        end
    end)
    
    print("âœ… ÄÃ£ bÃ¡n!")
    task.wait(0.5)
    return true
end


local function getUUID(obj)
    local uuid = obj:GetAttribute("UUID")
    if uuid then return uuid end
    
    for _, v in pairs(obj:GetAttributes()) do
        if type(v) == "string" and v:match("%x%x%x%x%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%x%x%x%x%x%x%x%x") then
            return v
        end
    end
end

local function isInList(name, list)
    for _, item in pairs(list) do
        if name:lower():find(item:lower()) then
            return true
        end
    end
    return false
end

local function removeAllPetsFromPlots()
    local workspace = game:GetService("Workspace")
    local plots = workspace:FindFirstChild("Plots")
    
    if not plots then
        warn("âŒ KhÃ´ng tÃ¬m tháº¥y Plots")
        return
    end
    
    local count = 0
    
    for _, plot in pairs(plots:GetChildren()) do
        local plants = plot:FindFirstChild("Plants")
        if plants then
            for _, plant in pairs(plants:GetChildren()) do
                if isInList(plant.Name, _G.CF.ListPetGift) then
                    local uuid = getUUID(plant)
                    
                    if uuid then
                        local success = pcall(function()
                            removeRemote:FireServer(uuid)
                        end)
                        
                        if success then
                            count = count + 1
                            print("âœ… ÄÃ£ xÃ³a:", plant.Name)
                            task.wait(0.3)
                        else
                            warn("âŒ Lá»—i xÃ³a:", plant.Name)
                        end
                    end
                end
            end
        end
    end
    
    print(("ðŸ—‘ï¸ ÄÃ£ xÃ³a %d pets khá»i plots"):format(count))
end


local function isFavorited(slot)
    local heart = slot:FindFirstChild("HeartIcon")
    return heart and heart.Visible
end

local function getPetName(slot)
    local name = slot:GetAttribute("PetName")
    if name then return name end
    
    for _, child in ipairs(slot:GetDescendants()) do
        if child:IsA("TextLabel") and child.Text ~= "" and not tonumber(child.Text) then
            return child.Text
        end
    end
end

local function tryFavorite(slot, idx, location)
    local petName = getPetName(slot)
    if not petName or not isInList(petName, _G.CF.ListPetGift) then 
        return false 
    end
    
    if isFavorited(slot) then
        return true
    end

    local uuid = getUUID(slot)
    
    -- Náº¿u khÃ´ng tÃ¬m tháº¥y UUID trong slot, tÃ¬m trong Backpack
    if not uuid then
        for _, item in ipairs(Backpack:GetChildren()) do
            if item.Name:lower():find(petName:lower()) then
                uuid = getUUID(item)
                if uuid then break end
            end
        end
    end

    if uuid then
        print(("â­ [%s] Favorite: %s (Slot %d)"):format(location, petName, idx))
        FavoriteRemote:FireServer(uuid)
        task.wait(0.3)
        return true
    else
        warn(("âŒ [%s] KhÃ´ng tÃ¬m tháº¥y UUID: %s"):format(location, petName))
    end
    return false
end

local function scanAndFavoritePets()
    local backpackGui = LocalPlayer:FindFirstChild("PlayerGui")
    if not backpackGui then 
        warn("âŒ KhÃ´ng tÃ¬m tháº¥y PlayerGui")
        return 
    end
    
    backpackGui = backpackGui:FindFirstChild("BackpackGui")
    if not backpackGui then 
        warn("âŒ KhÃ´ng tÃ¬m tháº¥y BackpackGui")
        return 
    end
    
    local containers = {
        {
            path = {"Backpack","Inventory","ScrollingFrame","UIGridFrame"}, 
            range = 250, 
            name = "Inventory"
        },
        {
            path = {"Backpack","Hotbar"}, 
            range = 10, 
            name = "Hotbar"
        },
    }

    for _, cfg in ipairs(containers) do
        local gui = backpackGui
        
        for _, name in ipairs(cfg.path) do
            if gui then 
                gui = gui:FindFirstChild(name) 
            else
                break
            end
        end
        
        if not gui then
            warn("âŒ KhÃ´ng tÃ¬m tháº¥y:", cfg.name)
        else
            print(("ðŸ” QuÃ©t %s..."):format(cfg.name))
            local count = 0
            
            for i = 1, cfg.range do
                local slot = gui:FindFirstChild(tostring(i))
                if slot and tryFavorite(slot, i, cfg.name) then
                    count = count + 1
                end
            end
            
            if count > 0 then
                print(("  âœ… %s: %d pets favorite"):format(cfg.name, count))
            end
        end
    end
end


local function CheckAndManageInventory()
    if not Backpack then
        warn("âŒ Backpack khÃ´ng tá»“n táº¡i")
        return
    end
    
    local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
    if not playerGui then return end
    
    local hud = playerGui:FindFirstChild("HUD")
    if not hud then return end
    
    local maxInvObj = hud:FindFirstChild("MaxInv")
    if not maxInvObj then return end
    
    local maxInventory = 250
    if maxInvObj:IsA("IntValue") or maxInvObj:IsA("NumberValue") then
        maxInventory = maxInvObj.Value
    elseif maxInvObj:IsA("TextLabel") or maxInvObj:IsA("TextBox") then
        maxInventory = tonumber(maxInvObj.Text) or 250
    end
    
    local itemCount = #Backpack:GetChildren()
    
    if itemCount >= maxInventory then
        print("ðŸ”´ Inventory Äáº¦Y!")
        print("  â†’ BÆ°á»›c 1: BÃ¡n items...")
        pcall(SellMaxInventory)
        task.wait(3)
        print("  â†’ BÆ°á»›c 2: XÃ³a pets khá»i plots...")
        pcall(removeAllPetsFromPlots)
    else
        print("ðŸŸ¢ Inventory OK, xÃ³a pets khá»i plots...")
        pcall(removeAllPetsFromPlots)
    end
end


spawn(function()
    task.wait(2)
    print("\n" .. string.rep("=", 60))
    print("ðŸš€ SCRIPT STARTED!")
    print(string.rep("=", 60))
    
    while true do
        -- 1. Quáº£n lÃ½ inventory
        print("\nðŸ” Kiá»ƒm tra inventory...")
        pcall(CheckAndManageInventory)
        task.wait(2)
        
        -- 2. Auto favorite (náº¿u báº­t)
        if _G.CF.autoFavorite then
            print("\nâ­ QuÃ©t vÃ  favorite pets...")
            pcall(scanAndFavoritePets)
            task.wait(1)
        end
        
        -- 3. Gá»­i quÃ  (náº¿u báº­t)
        if _G.CF.autoSendGift then
            print("\nðŸŽ Gá»­i quÃ ...")
            pcall(ToGift)
        end
        
        print("\nâ³ Äá»£i 5 giÃ¢y...")
        print(string.rep("=", 60))
        task.wait(5)
    end
end)

