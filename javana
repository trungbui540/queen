if not game:IsLoaded() then game.Loaded:Wait() end

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local plr = Players.LocalPlayer
local LocalPlayer = plr
local character = plr.Character or plr.CharacterAdded:Wait()
local giftRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("GiftItem")
local acceptRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("AcceptGift")
local removeRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("RemoveItem")
local ItemSell = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("ItemSell")
local Backpack = plr:FindFirstChild("Backpack")
local giftedCount, giftQueue = {}, {}

plr.CharacterAdded:Connect(function(newChar)
    character = newChar
    task.wait(1)
    Backpack = plr:FindFirstChild("Backpack")
end)

local function hookAllRemotes()
    for _, obj in pairs(ReplicatedStorage:GetDescendants()) do
        if obj:IsA("RemoteEvent") and obj.OnClientEvent then
            obj.OnClientEvent:Connect(function(...)
                for _, arg in pairs({...}) do
                    if typeof(arg) == "table" and arg.ID and typeof(arg.ID) == "number" and arg.ID > 1000000000 then
                        table.insert(giftQueue, arg.ID)
                    end
                end
            end)
        end
    end
end

spawn(function()
    hookAllRemotes()
    while task.wait(1) do
        if _G.CF.acceptGifts and #giftQueue > 0 then
            local giftID = table.remove(giftQueue, 1)
            pcall(function()
                acceptRemote:FireServer({ID = giftID})
                print("‚úÖ Accepted gift:", giftID)
            end)
        end
    end
end)

local function ToGift()
    local receivers = type(_G.CF.Receivers) == "table" and _G.CF.Receivers or {_G.CF.Receivers}
    local Humanoid = character:FindFirstChildOfClass("Humanoid")
    local totalSent = 0
    local COOLDOWN = _G.CF.giftCooldown or 10

    for _, receiverName in pairs(receivers) do
        local receiver = Players:FindFirstChild(receiverName)
        if not receiver then
            print("‚ö†Ô∏è Receiver", receiverName, "kh√¥ng online, b·ªè qua.")
            continue
        end

        for _, petName in pairs(_G.CF.ListPetGift) do
            for _, item in pairs(Backpack:GetChildren()) do
                if item:IsA("Tool") and string.find(item.Name:lower(), petName:lower()) then
                    pcall(function() Humanoid:EquipTool(item) end)
                    task.wait(0.5)
                    local petTool = character:FindFirstChildOfClass("Tool")

                    if petTool then
                        pcall(function()
                            giftRemote:FireServer({Item = petTool, ToGift = receiverName})
                        end)
                        print("üì§ ƒê√É G·ª¨I:", petTool.Name, "cho", receiverName)
                        totalSent += 1
                        task.wait(COOLDOWN)
                    end
                    break
                end
            end
        end
    end
end

local function SellMy()
    pcall(function() ItemSell:FireServer() end)
    print("üí∞ ƒê√£ g·ª≠i y√™u c·∫ßu b√°n, ch·ªù popup hi·ªán...")

    local popupGui = LocalPlayer.PlayerGui:WaitForChild("HUD"):WaitForChild("PopUp")
    repeat task.wait(0.05) until popupGui.Visible or yesBtn.Visible
    task.wait(0.2)

    local yesBtn = popupGui.Content.Buttons.Yes.TextButton
    print("üü¢ Popup ƒë√£ m·ªü, b·∫•m YES...")

    for _, conn in pairs(getconnections(yesBtn.Activated)) do pcall(conn.Function) end
    task.wait(0.05)
    for _, conn in pairs(getconnections(yesBtn.MouseButton1Click)) do pcall(conn.Function) end
end

local function removeAllPetsFromPlots()
    local count = 0
    for _, plot in pairs(workspace.Plots:GetChildren()) do
        local hitboxes = plot:FindFirstChild("Hitboxes")
        if hitboxes then
            for _, pet in pairs(hitboxes:GetChildren()) do
                if pcall(function() removeRemote:FireServer(pet.Name) end) then
                    count += 1
                    task.wait(0.3)
                end
            end
        end
    end
    print("üßπ ƒê√£ g·ª°", count, "pet kh·ªèi plot.")
end

spawn(function()
    SellMy()
    task.wait(3)
    removeAllPetsFromPlots()
    while task.wait(5) do
        if _G.CF.autoSendGift then
            ToGift()
        end
    end
end)
