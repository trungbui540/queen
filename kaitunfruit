repeat
	task.wait()
until game:IsLoaded()

local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CommF = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("CommF_")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

function Join(v2)
	v2 = tostring(v2) or "Pirates"
	v2 = string.find(v2, "Marine") and "Marines" or "Pirates"
	local chooseTeam = LocalPlayer.PlayerGui["Main (minimal)"].ChooseTeam.Container[v2].Frame.TextButton.Activated
	for _, connection in pairs(getconnections(chooseTeam)) do
		connection.Function()
	end
end

if not LocalPlayer.Team then
	repeat
		pcall(function()
			task.wait()
			if LocalPlayer.PlayerGui["Main (minimal)"]:FindFirstChild("ChooseTeam") then
				Join(getgenv().lugiadev.Team)
			end
		end)
	until LocalPlayer.Team ~= nil
end

local gaName = "Memwwmfnweiewfwef"
local ga
local aall = tick()

if _G.HeartbeatConnection then
	_G.HeartbeatConnection:Disconnect()
	_G.HeartbeatConnection = nil
end

_G.HeartbeatConnection = RunService.Heartbeat:Connect(function()
	local character = LocalPlayer.Character
	if
		tick() - aall > 0.5
		and character
		and character.PrimaryPart
		and not character.PrimaryPart:FindFirstChild("NEWQL")
	then
		aall = tick()
		local BodyVel = Instance.new("BodyVelocity", character.PrimaryPart)
		BodyVel.Velocity = Vector3.new(0, 0, 0)
		BodyVel.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
		BodyVel.P = 15000
		BodyVel.Name = "NEWQL"
	end
	if (1 > 0 or tick() - aall > 0.5) and ga then
		character:MoveTo(ga.Position)
		character.PrimaryPart.CFrame =
			CFrame.new(character.PrimaryPart.CFrame.X, ga.Position.Y, character.PrimaryPart.CFrame.Z)
	end
end)

local function extractMinutesFromText(text)
	local hours, minutes = string.match(text, "(%d+):(%d+)")
	if hours and minutes then
		return tonumber(hours) * 60 + tonumber(minutes)
	end
	return nil
end

local function tweenObjectToTarget(object, target, speed)
	ga = workspace:FindFirstChild(gaName) or Instance.new("Part", workspace)
	ga.Name = gaName
	ga.Size = Vector3.new(0, 0, 0)
	ga.CanCollide = false
	ga.Anchored = true

	if not object or not target then
		warn("Object hoặc Target không tồn tại!")
		return
	end

	local distance = (target.Position - object.Position).Magnitude
	speed = speed or (distance < 800 and 500 or (distance > 800 and distance < 1500 and 500 or 325))
	local time = distance / speed
	local tweenInfo = TweenInfo.new(time, Enum.EasingStyle.Linear)
	local properties = { Position = target.Position }
	ga.CFrame = LocalPlayer.Character.PrimaryPart.CFrame

	local tween = TweenService:Create(ga, tweenInfo, properties)
	tween:Play()
	tween.Completed:Wait()
	ga = nil
	return tween
end

local function sendStatusUpdate()
	pcall(function()
		request({
			Url = getgenv().lugiadev.ToolUrl .. "/update-status",
			Method = "POST",
			Headers = {
				["Content-Type"] = "application/json",
			},
			Body = game:GetService("HttpService"):JSONEncode({
				account = LocalPlayer.Name,
			}),
		})
	end)
end

local function sendScheduleRequest(minutes)
	pcall(function()
		request({
			Url = getgenv().lugiadev.ToolUrl .. "/register-schedule",
			Method = "POST",
			Headers = {
				["Content-Type"] = "application/json",
			},
			Body = game:GetService("HttpService"):JSONEncode({
				account = LocalPlayer.Name,
				minutes = minutes,
			}),
		})
	end)
end

local function sendCloseRequest()
	pcall(function()
		request({
			Url = getgenv().lugiadev.ToolUrl .. "/close-account",
			Method = "POST",
			Headers = {
				["Content-Type"] = "application/json",
			},
			Body = game:GetService("HttpService"):JSONEncode({
				account = LocalPlayer.Name,
			}),
		})
	end)
end

local lastUpdateSent = tick()
local isSent = false
sendStatusUpdate()

local function sendWebhook(message, customUrl)
	pcall(function()
		request({
			Url = customUrl or getgenv().lugiadev.WebhookUrl,
			Method = "POST",
			Headers = {
				["Content-Type"] = "application/json",
			},
			Body = game:GetService("HttpService"):JSONEncode({
				content = tostring(LocalPlayer.Name) .. ": " .. tostring(message),
			}),
		})
	end)
end

local function getBackpackFruit()
	for _, path in pairs({ LocalPlayer.Backpack, LocalPlayer.Character }) do
		for _, v in pairs(path:GetChildren()) do
			if v.Name:find("Fruit") then
				return v
			end
		end
	end
end

local function GetDistance(target1, target2)
	target2 = target2 or LocalPlayer.Character.HumanoidRootPart
	if target1 and target2 then
		return (target1.Position - target2.Position).Magnitude
	end
	return math.huge
end

local OriginalCFrame = CFrame.new(
	-1028.91907,
	73.0010605,
	-205.090897,
	0.911521077,
	2.39416345e-08,
	0.411253393,
	-5.56267636e-08,
	1,
	6.50774794e-08,
	-0.411253393,
	-8.21961876e-08,
	0.911521077
)

local NewCFrame = OriginalCFrame * CFrame.new(0, 18, 0)

local function serializeCFrame(cf)
	return { Components = { cf:GetComponents() } }
end

local function deserializeCFrame(data)
	if data and data.Components then
		return CFrame.new(unpack(data.Components))
	end
	return nil
end

local function DropFruit()
	local char = LocalPlayer.Character
	local back = LocalPlayer.Backpack

	for _, v in pairs(char:GetChildren()) do
		if v:IsA("Tool") and v:FindFirstChild("Fruit") then
			local eatRemote = v:FindFirstChild("EatRemote")
			if eatRemote then
				if eatRemote:IsA("RemoteFunction") then
					eatRemote:InvokeServer("Drop")
				else
					eatRemote:FireServer("Drop")
				end
				print("Dropped:", v.Name)
				return true
			end
		end
	end

	for _, v in pairs(back:GetChildren()) do
		if v:IsA("Tool") and v:FindFirstChild("Fruit") then
			v.Parent = char
			task.wait(0.5)
			local eatRemote = v:FindFirstChild("EatRemote")
			if eatRemote then
				if eatRemote:IsA("RemoteFunction") then
					eatRemote:InvokeServer("Drop")
				else
					eatRemote:FireServer("Drop")
				end
				print("Dropped:", v.Name)
				return true
			end
		end
	end
	return false
end

local function buyrandomfruit()
	local success, result = pcall(function()
		return CommF:InvokeServer("Cousin", "Buy")
	end)
	
	if not success then
		return false
	end
	
	local playergui = game:GetService("Players").LocalPlayer.PlayerGui
	local timeout = 0
	local maxTimeout = 10
	
	local spinnerWindow
	repeat
		task.wait(0.1)
		timeout = timeout + 0.1
		spinnerWindow = playergui:FindFirstChild("SpinnerWindow")
		
		if timeout > maxTimeout then
			return false
		end
	until spinnerWindow
	
	local button = spinnerWindow:WaitForChild("CloseButton", 2)

	repeat
		task.wait(0.1)
		timeout = timeout + 0.1
		
		if timeout > maxTimeout then
			return false
		end
	until button.Visible
	
	pcall(function()
		for _, conn in pairs(getconnections(button.Activated)) do
			conn:Fire()
		end
	end)
	
	return result
end

-- NEW: Drop fruit position table
local function dropfruitpoint()
	return {
		["Quake"] = Vector3.new(-831.09, 73.27, 49.26),
		["Buddha"] = Vector3.new(-865.87, 73.27, 13.34),
		["Love"] = Vector3.new(-900.65, 73.27, -22.58),
		["Creation"] = Vector3.new(-935.43, 73.27, -58.50),
		["Spider"] = Vector3.new(-970.21, 73.27, -94.42),
		["Sound"] = Vector3.new(-1005.00, 73.27, -130.34), 
		["Phoenix"] = Vector3.new(-1039.78, 73.27, -166.26),
		["Portal"] = Vector3.new(-722.66, 73.27, -47.16),
		["Lightning"] = Vector3.new(-757.49, 73.27, -83.03),
		["Pain"] = Vector3.new(-792.32, 73.27, -118.90),
		["Blizzard"] = Vector3.new(-827.15, 73.27, -154.78),
		["Gravity"] = Vector3.new(-861.98, 73.27, -190.65),
		["Mammoth"] = Vector3.new(-896.81, 73.27, -226.52),
		["T-Rex"] = Vector3.new(-931.64, 73.27, -262.39),
		["Dough"] = Vector3.new(-962.18, 73.27, -288.00), 
		["Shadow"] = Vector3.new(-982.53, 73.27, -333.67),
		["Venom"] = Vector3.new(-1002.88, 73.27, -379.34),
		["Control"] = Vector3.new(-1023.23, 73.27, -425.01),
		["Gas"] = Vector3.new(-1043.58, 73.27, -470.69),
		["Spirit"] = Vector3.new(-1076.18, 73.27, -224.30),
		["Tiger"] = Vector3.new(-1100.60, 73.27, -267.93),
		["Yeti"] = Vector3.new(-1125.02, 73.27, -311.56),
		["Kitsune"] = Vector3.new(-1149.44, 73.27, -355.19),
		["Dragon"] = Vector3.new(-1173.86, 73.27, -398.82),
		["fruit pulp"] = Vector3.new(-526.96, 73.27, -110.69),
	}
end

-- NEW: Get current fruit name
local function GetCurrentFruitName()
	local char = LocalPlayer.Character
	local back = LocalPlayer.Backpack
	
	for _, v in pairs(char:GetChildren()) do
		if v:IsA("Tool") and v:FindFirstChild("Fruit") then
			return v.Name
		end
	end
	
	for _, v in pairs(back:GetChildren()) do
		if v:IsA("Tool") and v:FindFirstChild("Fruit") then
			return v.Name
		end
	end
	
	return nil
end

-- NEW: Get drop position for current fruit
local function GetDropPosition()
	local fruitPoints = dropfruitpoint()
	local fruitName = GetCurrentFruitName()
	
	if not fruitName then
		return nil
	end
	
	-- Remove "Fruit" suffix and trim spaces
	local cleanName = fruitName:gsub("Fruit", ""):gsub("%s+", "")
	
	-- Find matching position
	for name, point in pairs(fruitPoints) do
		if name:lower():gsub("%s+", "") == cleanName:lower() then
			print("✓ Found drop position for:", fruitName, "->", name)
			return point
		end
	end
	
	-- Use default position if not found
	print("⚠ No position found for:", fruitName, "-> using 'fruit pulp'")
	return fruitPoints["fruit pulp"]
end

local storage = isfile("FruitPos.json") and game:GetService("HttpService"):JSONDecode(readfile("FruitPos.json")) or {}
task.spawn(function()
	while task.wait() do
		local succ, err = pcall(function()
			if not getgenv().lugiadev.AutoRandom then
				return
			end

			if game.PlaceId ~= 4442272183 then
				game.ReplicatedStorage.Remotes.CommF_:InvokeServer("TravelDressrosa")
				task.wait(1)
				return
			end

			if tick() - lastUpdateSent >= 0.5 * 60 then
				lastUpdateSent = tick()
				sendStatusUpdate()
			end

			local FruitInventory = getBackpackFruit()
			if FruitInventory then
				-- NEW: Get drop position from table
				local dropPos = GetDropPosition()
				
				if dropPos then
					-- Use custom drop position
					OriginalCFrame = CFrame.new(dropPos)
				else
					-- Fallback to storage or default
					OriginalCFrame = storage[FruitInventory:GetAttribute("OriginalName")]
							and deserializeCFrame(storage[FruitInventory:GetAttribute("OriginalName")])
						or OriginalCFrame
				end
				
				NewCFrame = OriginalCFrame * CFrame.new(0, 15, 0)
				tweenObjectToTarget(LocalPlayer.Character.PrimaryPart, NewCFrame, 340)
				
				if GetDistance(NewCFrame) < 10 then
					sendWebhook("thais trun cho ban mot trai cay: " .. FruitInventory:GetAttribute("OriginalName"))
					
					local bodyVel = LocalPlayer.Character.PrimaryPart:FindFirstChildOfClass("BodyVelocity")
					if bodyVel then
						bodyVel.Velocity = Vector3.new(0, 0, 0)
					end
					
					-- Drop fruit
					DropFruit()
					task.wait(1)
					
					bodyVel = LocalPlayer.Character.PrimaryPart:FindFirstChildOfClass("BodyVelocity")
					if bodyVel then
						bodyVel.Velocity = Vector3.new(0, 5, 0)
					end
				end
				return
			end

			local BuyRandomFruit = buyrandomfruit()
			if BuyRandomFruit == true then
				LocalPlayer.Character.PrimaryPart.CFrame = CFrame.new(
					LocalPlayer.Character.PrimaryPart.CFrame.X,
					200,
					LocalPlayer.Character.PrimaryPart.CFrame.Z
				)
				return
			elseif type(BuyRandomFruit) == "string" then
				local Minutes = extractMinutesFromText(BuyRandomFruit)
				if Minutes then
					if not isSent then
						isSent = true
						sendScheduleRequest(Minutes)
						sendCloseRequest()
						task.delay(3, function()
							game:Shutdown()
						end)
					end
					return
				end
			end

			if LocalPlayer.Data.LastSpawnPoint.Value ~= "Bar" then
				LocalPlayer.Character.PrimaryPart.CFrame = CFrame.new(
					LocalPlayer.Character.PrimaryPart.CFrame.X,
					100,
					LocalPlayer.Character.PrimaryPart.CFrame.Z
				)
				tweenObjectToTarget(
					LocalPlayer.Character.PrimaryPart,
					CFrame.new(
						-386.327789,
						100.0021667,
						344.19931,
						0.938858271,
						1.26722133e-09,
						0.344303817,
						2.56867807e-08,
						1,
						-7.37240384e-08,
						-0.344303817,
						7.80604807e-08,
						0.938858271
					),
					315
				)
			end
		end)

		if not succ then
			sendWebhook(tostring(err))
		end

		task.wait(1)
	end
end)
